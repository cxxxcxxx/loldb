{% extends "base.html" %}
{% block content %}
<h1>Items zum Block hinzuf√ºgen</h1>

<form id="item-form">
    {% for cat, items in items_by_category.items() %}
        <h3>{{ cat.upper() }} Items</h3>
        <div class="item-grid-category">
            {% for item in items %}
                <label class="item-label">
                    <input type="checkbox" name="item_name" value="{{ cat }}/{{ item }}" style="display:none;">
                    <img src="{{ url_for('static', filename='items/' + cat + '/' + item) }}" class="selectable-item">
                </label>
            {% endfor %}
        </div>
    {% endfor %}
    <br>
    <button type="submit" class="btn-add-item">Hinzuf√ºgen</button>
</form>

<style>
.item-grid-category {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
}

.item-label img {
    width: 60px;
    height: 60px;
    object-fit: contain;
    border-radius: 5px;
    cursor: pointer;
    transition: 0.2s;
}

.selectable-item.selected {
    outline: 3px solid #ffcc00; /* Goldener Ring */
    outline-offset: 2px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const items = document.querySelectorAll(".selectable-item");
    items.forEach(item => {
        item.addEventListener("click", () => {
            const checkbox = item.previousElementSibling;
            checkbox.checked = !checkbox.checked;
            item.classList.toggle("selected");
        });
    });

    document.getElementById("item-form").addEventListener("submit", (e) => {
        e.preventDefault();

        const selectedItems = Array.from(document.querySelectorAll('input[name="item_name"]:checked')).map(i => i.value);

        // Kommunikation mit dem opener (Editor)
        if(window.opener) {
            const idx = {{ block_index }}; // Index des Blocks im Editor
            const block = window.opener.document.querySelector(`#blocks-container .block[data-index="${idx}"]`);
            const gridDiv = block.querySelector(".item-grid");

            selectedItems.forEach(itemPath => {
                const div = document.createElement("div");
                div.classList.add("item-slot");
                div.innerHTML = `
                    <img src="/static/items/${itemPath}" alt="Item">
                    <button type="button" class="delete-item">üóëÔ∏è</button>
                `;
                gridDiv.appendChild(div);

                // L√∂schen
                div.querySelector(".delete-item").addEventListener("click", ()=>{
                    div.remove();
                });
            });
        }

        window.close();
    });
});
</script>
{% endblock %}
