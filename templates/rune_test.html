{% extends "base.html" %}
{% block content %}
<div class="container py-3">
    <h1>Rune Picker — Test</h1>
    <p>Wähle eine Rune-Slot (links) an, dann klicke ein Icon (rechts) um es dem Slot zuzuordnen. Bestätige unten.</p>

    <div class="rune-panel d-flex gap-4">
        <div class="rune-grid">
            <div class="rune-col" data-col="keystone">
                <div class="col-title">Keystone (4)</div>
                <div class="slot" data-col="keystone" data-row="0" title="Slot 1"></div>
                <div class="slot" data-col="keystone" data-row="1" title="Slot 2"></div>
                <div class="slot" data-col="keystone" data-row="2" title="Slot 3"></div>
                <div class="slot" data-col="keystone" data-row="3" title="Slot 4"></div>
            </div>

            <div class="rune-col" data-col="subrune">
                <div class="col-title">Subrune (2)</div>
                <div class="slot" data-col="subrune" data-row="0" title="Slot 1"></div>
                <div class="slot" data-col="subrune" data-row="1" title="Slot 2"></div>
            </div>

            <div class="rune-col" data-col="smallrune">
                <div class="col-title">Smallrune (3)</div>
                <div class="slot" data-col="smallrune" data-row="0" title="Slot 1"></div>
                <div class="slot" data-col="smallrune" data-row="1" title="Slot 2"></div>
                <div class="slot" data-col="smallrune" data-row="2" title="Slot 3"></div>
            </div>
        </div>

        <div class="picker">
            <h5>Verfügbare Runen</h5>
            <div id="picker-list"></div>
        </div>
    </div>

    <div class="mt-3">
        <button id="clear-selection" class="btn btn-secondary">Alles löschen</button>
        <button id="confirm-selection" class="btn btn-primary">Bestätigen (JSON anzeigen)</button>
    </div>

    <pre id="result" class="mt-3 small p-3 bg-light border" style="display:none;"></pre>
</div>

<style>
/* styles same as earlier test page */
.slot { width:48px;height:48px;border-radius:8px;background:#f7f7f7;display:flex;align-items:center;justify-content:center;border:2px dashed #ddd;cursor:pointer;margin:6px;position:relative; }
.slot img { max-width:100%;max-height:100%;object-fit:contain;border-radius:6px; }
.picker { width:360px; max-height:420px; overflow:auto; border:1px solid #eee; padding:10px; border-radius:8px; background:#fff; }
.picker-category { margin-bottom:12px; }
.picker-wrap { display:flex; flex-wrap:wrap; gap:6px; }
.picker-item { width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:6px; cursor:pointer; padding:3px; border:2px solid transparent; background:#fafafa; }
.picker-item.selected { border-color:#ffcc00; box-shadow:0 2px 6px rgba(0,0,0,0.12); }
</style>

<script>
let runesAvailable = {};
let activeSlot = null;
let selection = { keystone:[null,null,null,null], subrune:[null,null], smallrune:[null,null,null] };

async function loadRunes() {
    try {
        const res = await fetch("/api/runes");
        if (!res.ok) throw new Error("api/runes failed");
        runesAvailable = await res.json();
        renderPicker();
    } catch (e) {
        console.error("Failed to load runes:", e);
        document.getElementById("picker-list").innerHTML = "<div class='text-danger'>Fehler beim Laden der Runen (siehe Konsole).</div>";
    }
}

function renderPicker() {
    const list = document.getElementById("picker-list");
    list.innerHTML = "";
    const desired = ["keystone","subrune","smallrune"];
    const keys = Object.keys(runesAvailable).sort((a,b)=>{
        const ia = desired.indexOf(a.toLowerCase()), ib = desired.indexOf(b.toLowerCase());
        if (ia===-1 && ib===-1) return a.localeCompare(b);
        if (ia===-1) return 1;
        if (ib===-1) return -1;
        return ia-ib;
    });
    for (const cat of keys) {
        const files = runesAvailable[cat];
        const container = document.createElement("div");
        container.className = "picker-category";
        const title = document.createElement("h6");
        title.textContent = cat.toUpperCase();
        container.appendChild(title);
        const wrap = document.createElement("div"); wrap.className = "picker-wrap";
        files.forEach(fname => {
            const el = document.createElement("div"); el.className = "picker-item";
            const img = document.createElement("img"); img.src = `/static/runes/${cat}/${fname}`; img.alt = fname;
            img.onerror = function(){ this.style.opacity = 0.4; };
            el.appendChild(img);
            el.addEventListener("click", () => {
                if (!activeSlot) { console.log("Bitte zuerst einen Slot anklicken."); return; }
                const col = activeSlot.col, row = activeSlot.row;
                if (!selection[col]) selection[col]=[];
                selection[col][row] = `${cat}/${fname}`;
                refreshAllSlots();
            });
            wrap.appendChild(el);
        });
        container.appendChild(wrap);
        list.appendChild(container);
    }
}

function slotClicked(col,row,dom){
    if (activeSlot && activeSlot.col===col && activeSlot.row===row) {
        dom.classList.remove("selected-slot"); activeSlot=null; return;
    }
    document.querySelectorAll(".slot").forEach(s=>s.classList.remove("selected-slot"));
    dom.classList.add("selected-slot"); activeSlot={col,row};
}

function updateSlotUI(col,row){
    const val = selection[col] && selection[col][row] ? selection[col][row] : null;
    const slot = document.querySelector(`.slot[data-col="${col}"][data-row="${row}"]`);
    if (!slot) return;
    slot.innerHTML = "";
    if (val) {
        const parts = val.split("/");
        let src = `/static/runes/${parts[0]}/${parts[1]}`;
        const img = document.createElement("img"); img.src = src; img.onerror = function(){ this.style.opacity = 0.4; };
        slot.appendChild(img);
        const x = document.createElement("div"); x.textContent = "×"; x.style.position="absolute"; x.style.right="4px"; x.style.top="4px"; x.style.cursor="pointer"; x.style.color="#c33";
        x.addEventListener("click",(ev)=>{ ev.stopPropagation(); selection[col][row]=null; updateSlotUI(col,row); });
        slot.appendChild(x);
    } else {
        slot.innerHTML = `<div style="font-size:11px;color:#888;text-align:center;">+</div>`;
    }
}

function refreshAllSlots(){ for(const col of Object.keys(selection)){ selection[col].forEach((v,idx)=>updateSlotUI(col,idx)); } }
function clearAll(){ for(const col of Object.keys(selection)){ for(let i=0;i<selection[col].length;i++) selection[col][i]=null; } refreshAllSlots(); activeSlot=null; document.querySelectorAll(".slot").forEach(s=>s.classList.remove("selected-slot")); }
function getSelectionJSON(){ return selection; }

document.addEventListener("DOMContentLoaded",()=>{
    document.querySelectorAll(".slot").forEach(slot=>{
        const col=slot.dataset.col; const row=parseInt(slot.dataset.row,10);
        slot.addEventListener("click",()=>slotClicked(col,row,slot));
    });
    document.getElementById("clear-selection").addEventListener("click",()=>{ clearAll(); document.getElementById("result").style.display="none"; });
    document.getElementById("confirm-selection").addEventListener("click", ()=>{
        const res = getSelectionJSON();
        document.getElementById("result").textContent = JSON.stringify(res,null,2);
        document.getElementById("result").style.display = "block";
    });
    loadRunes().then(()=>refreshAllSlots());
});
</script>
{% endblock %}
